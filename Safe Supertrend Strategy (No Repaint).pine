// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © AIScripts

//@version=6
strategy("Safe Supertrend Strategy (No Repaint)", overlay=true, margin_long=100, margin_short=100)

// Inputs
atrLen  = input.int(10, "ATR Length")
atrMult = input.float(3.0, "ATR Multiplier")

// Core Calculations
atr   = ta.atr(atrLen)
ma    = ta.sma(close, atrLen)
upper = ma + atr * atrMult
lower = ma - atr * atrMult

// Direction logic (non-repainting)
// Uses previous bar values ONLY → all flips are confirmed
var int dir = 0

if close[1] > upper[1]
    dir := 1
else if close[1] < lower[1]
    dir := -1
else
    dir := dir[1]  // hold trend

// Plot reversal markers
plotshape(dir == 1 and dir[1] != 1, 
     title="Bull Start", location=location.belowbar, 
     style=shape.triangleup, color=color.new(color.green, 0), size=size.small)

plotshape(dir == -1 and dir[1] != -1, 
     title="Bear Start", location=location.abovebar, 
     style=shape.triangledown, color=color.new(color.red, 0), size=size.small)

// Strategy logic
longSignal  = dir == 1 and dir[1] != 1
shortSignal = dir == -1 and dir[1] != -1

if longSignal
    strategy.entry("Long", strategy.long)

if shortSignal
    strategy.entry("Short", strategy.short)
// Optional exit on reverse signals
if strategy.position_size > 0 and shortSignal
    strategy.close("Long")
if strategy.position_size < 0 and longSignal
    strategy.close("Short")
