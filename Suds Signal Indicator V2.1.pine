// Suds Signal Indicator V2.1

//@version=6
indicator("Suds Signal Indicator V2.0", overlay=true)

// === Inputs ===
ema10Len = input.int(10, "EMA 10 Length", minval=1)
ema20Len = input.int(20, "EMA 20 Length", minval=1)
ema50Len = input.int(50, "EMA 50 Length", minval=1)

rsiLen       = input.int(14, "RSI Length", minval=1)
rsiSrc       = input.source(close, "RSI Source")
rsiSmoothLen = input.int(14, "RSI SMA Smoothing Length", minval=1) // RSI → SMA smoothing

// === View Options ===
showEMAs   = input.bool(true, "Show EMAs on Price Chart")
buyColor   = input.color(color.lime,   "Buy Signal Color")
sellColor  = input.color(color.red,    "Sell Signal Color")
exitLColor = input.color(color.blue,   "Exit Long Color")
exitSColor = input.color(color.purple, "Exit Short Color")

// === Debounce / Cooldown ===
rearmBars    = input.int(3, "Debounce (re-arm after N false bars)", minval=0)
cooldownBars = input.int(0, "Global cooldown bars (optional)", minval=0)

// === Calculations ===
ema10 = ta.ema(close, ema10Len)
ema20 = ta.ema(close, ema20Len)
ema50 = ta.ema(close, ema50Len)

// RSI(14) → SMA(14)
rsiRaw = ta.rsi(rsiSrc, rsiLen)
rsiMA  = ta.sma(rsiRaw, rsiSmoothLen)

// === Strict states ===
emaBull  = ema10 > ema20 and ema20 > ema50
emaBear  = ema10 < ema20 and ema20 < ema50
rsiAbove = rsiMA > 50
rsiBelow = rsiMA < 50

// === Session handling (daily reset for day trading) ===
newSession = ta.change(time("D")) != 0

// === Composite & rising edges (bar close) ===
// (Modified: added price filter vs EMA10)
longComposite  = emaBull  and rsiAbove and close > ema10
shortComposite = emaBear  and rsiBelow and close < ema10

// Rising edge, but allow fresh start on new session
longRise  = longComposite  and (newSession or not longComposite[1])
shortRise = shortComposite and (newSession or not shortComposite[1])

// === Debounce ===
prevLongFalseRun  = newSession ? 100000 : nz(ta.barssince(longComposite)[1], 100000)
prevShortFalseRun = newSession ? 100000 : nz(ta.barssince(shortComposite)[1], 100000)
armedLong  = prevLongFalseRun  >= rearmBars
armedShort = prevShortFalseRun >= rearmBars

// === Optional cooldown ===
var int lastSignalBar = na
if newSession
//     lastSignalBar := na
cooldownOK = cooldownBars == 0 or na(lastSignalBar) or (bar_index - lastSignalBar >= cooldownBars)

// === Entry signals (bar close only) ===
longSignal  = barstate.isconfirmed and cooldownOK and armedLong  and longRise
shortSignal = barstate.isconfirmed and cooldownOK and armedShort and shortRise

// prevent double-fire same bar
// longSignal  := longSignal  and not shortSignal
// shortSignal := shortSignal and not longSignal
if longSignal or shortSignal
//     lastSignalBar := bar_index

// === Position tracking for exits ===
var int position = 0
if newSession
//     position := 0

if longSignal
//     position := 1
// else if shortSignal
//     position := -1

// === Exit logic: EMA10 & EMA20 cross ===
exitLong  = barstate.isconfirmed and position == 1  and ta.crossunder(ema10, ema20)
exitShort = barstate.isconfirmed and position == -1 and ta.crossover(ema10, ema20)
if exitLong or exitShort
//     position := 0

// === Plots ===
plot(showEMAs ? ema10 : na, color=color.new(color.green, 0),  title="EMA 10", linewidth=2)
plot(showEMAs ? ema20 : na, color=color.new(color.orange, 0), title="EMA 20", linewidth=2)
plot(showEMAs ? ema50 : na, color=color.new(color.red, 0),    title="EMA 50", linewidth=2)

// Entry signals
plotshape(longSignal,  title="Buy Signal",  location=location.belowbar, style=shape.triangleup,
     color=buyColor, size=size.small, text="BUY", textcolor=color.white)
plotshape(shortSignal, title="Sell Signal", location=location.abovebar, style=shape.triangledown,
     color=sellColor, size=size.small, text="SELL", textcolor=color.white)

// Exit signals
plotshape(exitLong,  title="Exit Long",  location=location.abovebar, style=shape.xcross,
     color=exitLColor, size=size.tiny, text="EXIT L", textcolor=color.white)
plotshape(exitShort, title="Exit Short", location=location.belowbar, style=shape.xcross,
     color=exitSColor, size=size.tiny, text="EXIT S", textcolor=color.white)

// === Alerts ===
// A) All: any entry or exit
anyLongEvent  = longSignal or exitLong
anyShortEvent = shortSignal or exitShort
anyEvent      = anyLongEvent or anyShortEvent

// alertcondition(anyEvent,      title="Suds V2 - All Signals",   message="Suds V2: BUY/SELL entry or EXIT")
// alertcondition(anyLongEvent,  title="Suds V2 - Long Signals",  message="Suds V2: LONG entry or EXIT LONG")
// alertcondition(anyShortEvent, title="Suds V2 - Short Signals", message="Suds V2: SHORT entry or EXIT SHORT")
