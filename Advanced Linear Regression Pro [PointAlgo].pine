// Advanced Linear Regression Pro [PointAlgo]



// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
//@version=5
indicator("Advanced Linear Regression Pro [PointAlgo]", overlay=true, max_labels_count=500, max_lines_count=500)

// ═══════════════════════════════════════════════════════════════════
// INPUT SETTINGS
// ═══════════════════════════════════════════════════════════════════

// Core Settings
length = input.int(50, "Regression Length", minval=1, group="Core Settings")
src = input.source(close, "Source", group="Core Settings")
bandMult = input.float(2.0, "Band Multiplier", minval=0.0, step=0.1, group="Core Settings")

// Volume Weighting
useVolumeWeight = input.bool(true, "Use Volume Weighting", group="Volume Analysis", tooltip="Weight regression by volume for institutional flow detection")
volumeMA = input.int(20, "Volume MA Period", minval=1, group="Volume Analysis")

// Multi-Timeframe
enableMTF = input.bool(true, "Enable Multi-Timeframe", group="Multi-Timeframe Analysis")
htfTimeframe = input.timeframe("60", "Higher Timeframe", group="Multi-Timeframe Analysis")

// Slope Strength
showSlopeStrength = input.bool(true, "Show Slope Strength", group="Slope Analysis")
slopeThreshold = input.float(0.0005, "Slope Strength Threshold", minval=0.0, step=0.0001, group="Slope Analysis")

// Order Flow Imbalance Detection
enableOFI = input.bool(true, "Enable Order Flow Imbalance", group="Order Flow", tooltip="Detect price imbalances for liquidity zones")
ofiThreshold = input.float(1.5, "Imbalance Threshold", minval=1.0, step=0.1, group="Order Flow")

// Breakout Signals
showBreakouts = input.bool(true, "Show Breakout Signals", group="Signals")
confirmBars = input.int(2, "Confirmation Bars", minval=1, group="Signals")

// Visual Settings
showFill = input.bool(true, "Show Band Fill", group="Visual")
showMidline = input.bool(true, "Show Midline", group="Visual")

// ═══════════════════════════════════════════════════════════════════
// CALCULATIONS
// ═══════════════════════════════════════════════════════════════════

// Volume-Weighted Linear Regression
volAvg = ta.sma(volume, volumeMA)
volWeight = useVolumeWeight ? volume / volAvg : 1.0

// Weighted price calculation
weightedPrice = src * volWeight
sumWeightedPrice = math.sum(weightedPrice, length)
sumWeight = useVolumeWeight ? math.sum(volWeight, length) : length
avgWeightedPrice = sumWeightedPrice / sumWeight

// Calculate volume-weighted linear regression
var float sumX = 0.0
var float sumXY = 0.0
var float sumX2 = 0.0

// sumX := 0.0
// sumXY := 0.0
// sumX2 := 0.0

for i = 0 to length - 1
    x = i
    y = useVolumeWeight ? (src[i] * volWeight[i]) : src[i]
    w = useVolumeWeight ? volWeight[i] : 1.0
//     sumX += x * w
//     sumXY += x * y
//     sumX2 += x * x * w

slope = (sumWeight * sumXY - sumX * sumWeightedPrice) / (sumWeight * sumX2 - sumX * sumX)
intercept = (sumWeightedPrice - slope * sumX) / sumWeight

// Current regression value
lr = intercept + slope * 0

// Standard deviation for bands
stdDev = ta.stdev(src, length)
upperBand = lr + stdDev * bandMult
lowerBand = lr - stdDev * bandMult

// ═══════════════════════════════════════════════════════════════════
// MULTI-TIMEFRAME ANALYSIS
// ═══════════════════════════════════════════════════════════════════

htfLR = enableMTF ? request.security(syminfo.tickerid, htfTimeframe, ta.linreg(src, length, 0)) : na
htfUpper = enableMTF ? request.security(syminfo.tickerid, htfTimeframe, ta.linreg(src, length, 0) + ta.stdev(src, length) * bandMult) : na
htfLower = enableMTF ? request.security(syminfo.tickerid, htfTimeframe, ta.linreg(src, length, 0) - ta.stdev(src, length) * bandMult) : na

// ═══════════════════════════════════════════════════════════════════
// SLOPE STRENGTH ANALYSIS
// ═══════════════════════════════════════════════════════════════════

slopeNormalized = slope / src * 100
slopeStrength = math.abs(slopeNormalized)
isBullishSlope = slopeNormalized > slopeThreshold
isBearishSlope = slopeNormalized < -slopeThreshold
isSideways = not isBullishSlope and not isBearishSlope

// Slope color gradient
slopeColor = isBullishSlope ? color.new(color.green, 0) : 
//              isBearishSlope ? color.new(color.red, 0) : 
//              color.new(color.gray, 0)

// ═══════════════════════════════════════════════════════════════════
// ORDER FLOW IMBALANCE DETECTION
// ═══════════════════════════════════════════════════════════════════

// Detect rapid price movements with volume
priceChange = math.abs(close - open)
avgPriceChange = ta.sma(priceChange, length)
isImbalance = enableOFI and (priceChange > avgPriceChange * ofiThreshold) and (volume > volAvg * 1.2)

bullishImbalance = isImbalance and close > open
bearishImbalance = isImbalance and close < open

// ═══════════════════════════════════════════════════════════════════
// BREAKOUT DETECTION
// ═══════════════════════════════════════════════════════════════════

bullishBreakout = ta.crossover(close, upperBand) and volume > volAvg * 1.3
bearishBreakout = ta.crossunder(close, lowerBand) and volume > volAvg * 1.3

// Confirmation
var int bullBreakoutConfirm = 0
var int bearBreakoutConfirm = 0

// bullBreakoutConfirm := bullishBreakout ? confirmBars : math.max(0, bullBreakoutConfirm - 1)
// bearBreakoutConfirm := bearishBreakout ? confirmBars : math.max(0, bearBreakoutConfirm - 1)

confirmedBullBreakout = showBreakouts and bullBreakoutConfirm > 0 and close > upperBand
confirmedBearBreakout = showBreakouts and bearBreakoutConfirm > 0 and close < lowerBand

// ═══════════════════════════════════════════════════════════════════
// PLOTTING
// ═══════════════════════════════════════════════════════════════════

// Main regression bands
plot(showMidline ? lr : na, "Linear Regression", color=slopeColor, linewidth=2)
pUpper = plot(upperBand, "Upper Band", color=color.new(color.green, 30), linewidth=1)
pLower = plot(lowerBand, "Lower Band", color=color.new(color.red, 30), linewidth=1)

// Fill
fill(pUpper, pLower, color=showFill ? color.new(color.yellow, 85) : na, title="Band Fill")

// Multi-timeframe plots
plot(enableMTF ? htfLR : na, "HTF Linear Regression", color=color.new(color.blue, 0), linewidth=3, style=plot.style_circles)
plot(enableMTF ? htfUpper : na, "HTF Upper Band", color=color.new(color.blue, 60), linewidth=1, style=plot.style_circles)
plot(enableMTF ? htfLower : na, "HTF Lower Band", color=color.new(color.blue, 60), linewidth=1, style=plot.style_circles)

// Order flow imbalance markers
plotshape(bullishImbalance, "Bullish Imbalance", shape.triangleup, location.belowbar, color=color.new(color.aqua, 0), size=size.tiny)
plotshape(bearishImbalance, "Bearish Imbalance", shape.triangledown, location.abovebar, color=color.new(color.orange, 0), size=size.tiny)

// Breakout signals - NO TEXT, ONLY SHAPES
plotshape(confirmedBullBreakout, "Bull Breakout", shape.circle, location.belowbar, color=color.new(color.green, 0), size=size.small)
plotshape(confirmedBearBreakout, "Bear Breakout", shape.circle, location.abovebar, color=color.new(color.red, 0), size=size.small)



// ═══════════════════════════════════════════════════════════════════
// ALERTS
// ═══════════════════════════════════════════════════════════════════

// alertcondition(confirmedBullBreakout, "Bullish Breakout", "Price broke above upper band with volume confirmation")
// alertcondition(confirmedBearBreakout, "Bearish Breakout", "Price broke below lower band with volume confirmation")
// alertcondition(bullishImbalance, "Bullish Imbalance", "Strong buying pressure detected - potential liquidity zone")
// alertcondition(bearishImbalance, "Bearish Imbalance", "Strong selling pressure detected - potential liquidity zone")
