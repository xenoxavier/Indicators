//@version=6
indicator("Filter Cross", shorttitle="Filter Cross", overlay=true, max_labels_count=500)

//---------------------------------------------------------
// INPUTS
//---------------------------------------------------------
fastLen         = input.int(50, "Fast MA Length")
slowLen         = input.int(200, "Slow MA Length")

regLen          = input.int(90, "Linear Regression Length")
lookbackTrend   = input.int(12, "Trend Comparison Lookback")
pThres          = input.int(90, "Trend Range Threshold (%)", minval=0, maxval=100)

volLook         = input.int(20, "Volume Lookback")
atrLen          = input.int(14, "ATR Length")

colBull         = input.color(#00ffbb, "Bull Color")
colBear         = input.color(#ff1100, "Bear Color")

//---------------------------------------------------------
// MOVING AVERAGES & CROSS
//---------------------------------------------------------
fast    = ta.sma(close, fastLen)
slow    = ta.sma(close, slowLen)

goldenCross = ta.crossover(fast, slow)
deadCross   = ta.crossunder(fast, slow)

//---------------------------------------------------------
// 1) TREND STRENGTH via Linear Regression Ordering
//---------------------------------------------------------
lr = ta.linreg(close, regLen, 0)

var trendScore = 0
trendScore := 0

for i = 0 to lookbackTrend - 2
    for j = i + 1 to lookbackTrend - 1
        trendScore += lr[i] > lr[j] ? 1 : lr[i] < lr[j] ? -1 : 0

totalPairs      = (lookbackTrend * (lookbackTrend - 1)) / 2
trendIntensity  = math.abs(trendScore) / totalPairs
trendUpThresh   = totalPairs * (pThres / 100)
trendDownThresh = -trendUpThresh

trendState = 0
trendState := trendScore > trendUpThresh ? 1 : trendScore < trendDownThresh ? -1 : 0

//---------------------------------------------------------
// 2) VOLATILITY POSITION (ATR)
//---------------------------------------------------------
atr = ta.atr(atrLen)

float volScore = 0.0
if close > fast + atr
    volScore := 1.0
else if close < fast - atr
    volScore := 0.0
else
    volScore := 0.5

//---------------------------------------------------------
// 3) VOLUME PRESSURE (above average = 1, else 0)
//---------------------------------------------------------
float volScore2 = 0.0
avgVol = ta.sma(volume, volLook)
if volume > avgVol
    volScore2 := 1.0
else
    volScore2 := 0.0

//---------------------------------------------------------
// 4) PRICE MOMENTUM vs FAST MA
//---------------------------------------------------------
float momScore = 0.0
if close > fast
    momScore := 1.0
else
    momScore := 0.0

//---------------------------------------------------------
// FINAL CONFIDENCE
//---------------------------------------------------------
rawConf     = (trendIntensity + volScore + volScore2 + momScore) / 4.0
confPercent = math.round(rawConf * 100.0)

//---------------------------------------------------------
// COLOR BLENDING (NO 삼항, NO 줄바꿈 꼬임)
//---------------------------------------------------------
alpha = 90 - int(trendIntensity * 70)

// 기본 회색
waveColor = color.new(color.gray, 80)

// 상태별로 색 덮어쓰기
if trendState == 1
    waveColor := color.new(colBull, alpha)
else if trendState == -1
    waveColor := color.new(colBear, alpha)

//---------------------------------------------------------
// SMOOTH 3-STEP
//---------------------------------------------------------
base = trendIntensity
s1 = ta.sma(base, 3)
s2 = ta.sma(s1, 3)
s3 = ta.sma(s2, 3)

//---------------------------------------------------------
// LABELS ON CROSS SIGNAL (한 줄에 다 씀)
//---------------------------------------------------------
if goldenCross
    label.new(bar_index, low, "Golden Cross\nConfidence: " + str.tostring(confPercent) + "%", style=label.style_label_up, color=color.new(colBull, 0), textcolor=color.black)

if deadCross
    label.new(bar_index, high, "Dead Cross\nConfidence: " + str.tostring(confPercent) + "%", style=label.style_label_down, color=color.new(colBear, 0), textcolor=color.white)
