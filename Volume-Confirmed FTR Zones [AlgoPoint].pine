// Volume-Confirmed FTR Zones [AlgoPoint]



//@version=5
// -----------------------------------------------------------------------------
// | ¬© AlgoPoint                                                               |
// | Indicator: Volume-Confirmed FTR Zones [AlgoPoint]                         |
// | Developer: Harmony Algo & AlgoPoint Collaboration                         |
// -----------------------------------------------------------------------------

indicator("Volume-Confirmed FTR Zones [AlgoPoint]", overlay = true, max_boxes_count = 500)

//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 1. INPUTS
//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
group_impulse      = "Impulse Detection"
atr_len            = input.int(21, "ATR Length", minval = 1, group = group_impulse)
atr_mult           = input.float(1.7, "Min Impulse Range (ATR Multiplier)", step = 0.1, group = group_impulse)
base_lookback      = input.int(3, "Base Lookback (bars before impulse)", minval = 1, group = group_impulse)

group_volume       = "Volume Filter"
use_volume         = input.bool(true, "Use Volume Confirmation", group = group_volume)
vol_len            = input.int(55, "Volume SMA Length", minval = 1, group = group_volume)
vol_mult           = input.float(2.5, "Volume SMA Multiplier", step = 0.1, group = group_volume)

group_zone         = "Zone Logic"
min_distance_bars  = input.int(55, "Min Bars Between Zones", minval = 1, group = group_zone)
max_zones          = input.int(10, "Max Zones Stored", minval = 10, maxval = 500, group = group_zone)

group_colors       = "Zone Colors"
demand_color       = input.color(color.new(color.teal, 70), "Demand (Bull FTR) Color", group = group_colors)
supply_color       = input.color(color.new(color.red, 70),  "Supply (Bear FTR) Color", group = group_colors)

//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 2. CORE CALCULATIONS
//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
atr_val   = ta.atr(atr_len)
vol_sma   = ta.sma(volume, vol_len)
vol_ok    = not use_volume or (use_volume and volume > vol_sma * vol_mult)

bar_range = high - low

// Impulse candles: strong move + volume confirmation
is_bull_impulse = close > open and bar_range > atr_val * atr_mult and vol_ok
is_bear_impulse = close < open and bar_range > atr_val * atr_mult and vol_ok

// Base area just before impulse
base_low  = ta.lowest(low[1],  base_lookback)
base_high = ta.highest(high[1], base_lookback)

//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 3. FTR ZONE STORAGE (PARALLEL ARRAYS)
//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var zone_low     = array.new_float()   // bottom of zone
var zone_high    = array.new_float()   // top of zone
var zone_dir     = array.new_int()     // +1 demand, -1 supply
var zone_created = array.new_int()     // bar index created
var zone_active  = array.new_bool()    // active or invalidated
var zone_box     = array.new_box()     // box handle

// f_zone_count() =>
//     array.size(zone_low)

//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 4. ADD ZONE HELPER (SAFE, NO OUT OF BOUNDS)
//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// f_add_zone(int dir, float z_low, float z_high) =>
    // Only valid zones with positive height
    if z_high > z_low
//         int size = f_zone_count()
//         int last_index = na

        if size > 0
//             last_index := array.get(zone_created, size - 1)

//         bool far_enough = na(last_index) or (bar_index - last_index >= min_distance_bars)

        if far_enough
//             array.push(zone_low,     z_low)
//             array.push(zone_high,    z_high)
//             array.push(zone_dir,     dir)
//             array.push(zone_created, bar_index)
//             array.push(zone_active,  true)
//             array.push(zone_box,     na)

//             int idx = f_zone_count() - 1
//             color col = dir == 1 ? demand_color : supply_color

//             box bx = box.new(bar_index, z_high, bar_index, z_low)
//             box.set_bgcolor(bx, col)
//             box.set_border_color(bx, color.new(color.white, 75))

//             array.set(zone_box, idx, bx)

            // Keep arrays within max_zones limit
//             int new_size = f_zone_count()
            if new_size > max_zones
//                 box bx_old = array.get(zone_box, 0)
                if not na(bx_old)
//                     box.delete(bx_old)
//                 array.shift(zone_low)
//                 array.shift(zone_high)
//                 array.shift(zone_dir)
//                 array.shift(zone_created)
//                 array.shift(zone_active)
//                 array.shift(zone_box)

//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 5. CREATE ZONES ON IMPULSE
//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Bullish impulse ‚Üí demand FTR zone
if is_bull_impulse
//     f_add_zone(1, base_low, base_high)

// Bearish impulse ‚Üí supply FTR zone
if is_bear_impulse
//     f_add_zone(-1, base_low, base_high)

//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 6. EXTEND ZONES TO THE RIGHT
//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// int count_extend = f_zone_count()
if count_extend > 0
    for i = 0 to count_extend - 1
//         bool active = array.get(zone_active, i)
        if active
//             box bx = array.get(zone_box, i)
            if not na(bx)
//                 box.set_right(bx, bar_index)

//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 7. INVALIDATION: WHEN PRICE BREAKS THE ZONE
//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// int count_inv = f_zone_count()
if count_inv > 0
    for i = count_inv - 1 to 0
//         bool active = array.get(zone_active, i)
        if active
//             float z_low  = array.get(zone_low, i)
//             float z_high = array.get(zone_high, i)
//             int   dir    = array.get(zone_dir, i)
//             box   bx     = array.get(zone_box, i)

//             bool broken_demand = dir == 1 and close < z_low
//             bool broken_supply = dir == -1 and close > z_high

            if broken_demand or broken_supply
//                 array.set(zone_active, i, false)
                if not na(bx)
//                     box.delete(bx)
//                     array.set(zone_box, i, na)



// FTR Zone Indicator ‚Äî Fail To Return Zones (With Volume Confirmation)

// Advanced Smart Money Zone Detection for Institutional Orderflow
// The FTR Zone Indicator is a professional-grade tool designed for traders who follow Smart Money Concepts (SMC), ICT methodologies, or institutional orderflow. It automatically detects Fail To Return Zones (FTR) ‚Äî high-probability supply and demand areas formed after strong displacement moves.

// By combining impulse detection, base identification, and volume confirmation, this indicator highlights zones where price is most likely to react, reverse, or mitigate shortly after structure breaks.

// ‚∏ª

// ‚≠ê What Are FTR Zones?

// FTR zones (Fail To Return zones) are price areas where:
// 1. A strong displacement / impulse candle is formed
// 2. That impulse originates from a small consolidation (base)
// 3. Price moves away aggressively
// 4. AND fails to return immediately to the origin area

// These zones often indicate:
// ‚Ä¢ Institutional orders
// ‚Ä¢ Imbalance
// ‚Ä¢ Hidden liquidity
// ‚Ä¢ Origin of a trend leg
// ‚Ä¢ High-probability mitigation points

// This indicator fully automates the detection and visualization of such areas.


// üîç How the Indicator Works

// 1. Impulse Detection
// The indicator identifies a valid impulse candle using:
// ‚Ä¢ ATR-based bar range filter
// ‚Ä¢ Trend-aligned candle body direction
// ‚Ä¢ Optional volume confirmation
// Only large, meaningful institutional candles qualify ‚Äî filtering out noise.

// 2. Base Zone Identification
// Before every impulse, the tool finds the micro-consolidation base using:
// ‚Ä¢ Highest high of the last X bars
// ‚Ä¢ Lowest low of the last X bars
// This base becomes the potential FTR zone.

// 3. FTR Zone Creation
// When a valid impulse is detected:
// ‚Ä¢ Bullish impulse ‚Üí Demand FTR zone
// ‚Ä¢ Bearish impulse ‚Üí Supply FTR zone
// The zone is immediately drawn on the chart using box.new().

// 4. Zone Extension
// Every zone continuously extends to the right as price evolves, allowing you to track:
// ‚Ä¢ Mitigation
// ‚Ä¢ Retests
// ‚Ä¢ Reaction points
// ‚Ä¢ Liquidity sweeps

// 5. Invalidation Logic
// Zones automatically delete when violated:
// ‚Ä¢ Demand zone invalid if close < zone low
// ‚Ä¢ Supply zone invalid if close > zone high
// This keeps the chart clean and helps focus only on active, high-value areas.


// üéõÔ∏è Key Features
// ‚úî Automatic FTR Zone Detection
// Instantly identifies institutional origin zones based on real impulse and displacement.

// ‚úî Volume-Based Filtering
// Ensures only high-volume impulses (true institutional orders) create zones.

// ‚úî Supply & Demand Coloring
// ‚Ä¢ Bullish FTR ‚Üí Demand Zone (Teal tone)
// ‚Ä¢ Bearish FTR ‚Üí Supply Zone (Red tone)

// ‚úî Safe Zone Storage
// Fault-tolerant logic ensures no array errors, invalid zones, or broken visuals.

// ‚úî Auto-Extending Boxes
// Real-time zone updates with precise historical mapping.

// ‚úî Smart Invalidation
// Zone is removed only when fully broken, preventing false signals.

// ‚úî Clean, Non-Repainting Logic
// Impulse detection and zone placement are confirmed only on bar close.


// üìà How to Use It (Example Schenarios)
// For Reversals or Continuations
// ‚Ä¢ Look for price reacting or mitigating inside a zone
// ‚Ä¢ Use as entry confirmation in trend continuations
// ‚Ä¢ Combine with FVG, BOS/CHOCH, liquidity sweeps, or premium/discount zones

// For Scalping or Intraday Trading
// ‚Ä¢ High-probability countertrend entries
// ‚Ä¢ Reaction-based setups at institutional footprints

// For Swing Traders
// ‚Ä¢ Identify weekly/daily origin zones
// ‚Ä¢ Plan entries around large displacement points